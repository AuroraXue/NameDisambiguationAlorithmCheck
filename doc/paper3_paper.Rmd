---
title: "Untitled"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(text2vec, dplyr, qlcMatrix, kernlab, knitr,tm,plyr)
setwd("/Users/apple/Documents/R/Spr2017-proj4-team10/data/nameset")
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r read-in txt}
#source('~/Dropbox/Project4_WhoIsWho/lib/evaluation_measures.R')
read_citation <- function(filename){
  #name <- deparse(substitute(filename))
  citation <- read.csv(filename,
                  header = F,
                  sep = "\n")    
 #remove symbols disturbing split
  rule = "<([[:alpha:]]|[[:punct:]]){1,4}>"
  citation$V1 = gsub(rule,"",citation$V1)
  rule1 = ">([[:alpha:]]){1,5}:"
  citation$V1 = gsub(rule1,">",citation$V1)
  #change the environment so we can split the citation
  Sys.setlocale('LC_ALL','C')
  #split the rows by ">""
  L <- strsplit(citation$V1,split = ">")
  #create a vector
  citation$Coauthor = laply(L,function(t) t[1])
  citation$Paper = laply(L,function(t) t[2])
  citation$Journal = laply(L,function(t) t[3])
  
  # extract canonical author id befor "_"
  citation$AuthorID <- as.numeric(sub("_.*","",citation$Coauthor))
  # extract paper number under same author between "_" and first whitespace
  citation$PaperNO <- as.numeric(sub(".*_(\\w*)\\s.*", "\\1", citation$Coauthor))
  # delete "<" in AKumar$Coauthor, you may need to further process the coauthor
  # term depending on the method you are using
  citation$Coauthor <- gsub("<","",sub("^.*?\\s","", citation$Coauthor))
  # delete "<" in AKumar$Paper
  citation$Paper <- gsub("<","",citation$Paper)
  # add PaperID for furthur use, you may want to combine all the nameset files and 
  # then assign the unique ID for all the citations
  citation$PaperID <- rownames(citation)
  return(citation)
}

file_names <- list.files(pattern = "*.txt")
Data = list()
for(i in 1:length(file_names)){
  Data[[i]]= read_citation(file_names[i])
  Data[[i]] <- na.omit(Data[[i]])
}
names(Data) = file_names
#save processed data
setwd("/Users/apple/Documents/R/Spr2017-proj4-team10/output")
save(result,file="text.Rdata")

```



```{r compute DTM, echo=FALSE}
cluster_citation<-function(file){
#vectorize paper tities & create dtm
source('/Users/apple/Documents/R/Spr2017-proj4-team10/lib/create_dtm.R')
dtm_paper <- vocabulary_Paper(file)

#delete papers whose rowSums are zero
#dtm_paper<-dtm_paper[which(rowSums(dtm_paper)!=0),]
#adjust the original data to keep the same length
# file_c<-file[which(rowSums(dtm_paper)!=0),]

# create tfidf matrix
dtm_tfidf <- as.matrix(fit_transform(dtm_paper, tfidf))
tfidf<-as.matrix(dtm_tfidf)

#create ntf matrix
dtm_tf<-apply(dtm_paper,1,function(term) term/sum(term))
ntf<-as.matrix(apply(dtm_tf,1,function(term) term/max(term)))

#apply spectral cluster function
source('/Users/apple/Documents/R/Spr2017-proj4-team10/lib/myspectralCluster.R')
#apply function myspectral cluster
set.seed(2)
cluster_tfidf <- myspectralCluster(as.matrix(tfidf), 
                       centers=length(unique(file$AuthorID)))
cluster_ntf <- myspectralCluster(as.matrix(ntf), 
                       centers=length(unique(file$AuthorID)))

return(list(c_tfidf=cluster_tfidf$myData, c_ntf=cluster_ntf$myData))
}


#apply whole cluster_citation function to do specl
Start_time<-Sys.time()
tfidf <- TfIdf$new()
freqs_AGupta<-cluster_citation(Data$AGupta.txt)
freqs_AKumar<-cluster_citation(Data$AKumar.txt)
freqs_CChen<-cluster_citation(Data$CChen.txt)
freqs_DJohnson<-cluster_citation(Data$DJohnson.txt)
freqs_JLee<-cluster_citation(Data$JLee.txt)
freqs_JMartin<-cluster_citation(Data$JMartin.txt)
freqs_JRobinson<-cluster_citation(Data$JRobinson.txt)
freqs_JSmith<-cluster_citation(Data$JSmith.txt)
freqs_JTanaka<-cluster_citation(Data$KTanaka.txt)
freqs_MBrown<-cluster_citation(Data$MBrown.txt)
freqs_MJones<-cluster_citation(Data$MJones.txt)
freqs_MMiller<-cluster_citation(Data$MMiller.txt)
freqs_SLee<-cluster_citation(Data$SLee.txt)
freqs_YChen<-cluster_citation(Data$YChen.txt)
Stop_time<-Sys.time()
run_time<-Stop_time - Start_time
result<-list(freqs_AGupta,freqs_AKumar,freqs_CChen,freqs_DJohnson,freqs_JLee,freqs_JMartin,freqs_JRobinson,freqs_JSmith,freqs_JTanaka,freqs_MBrown,freqs_MJones,freqs_MMiller,freqs_SLee,freqs_YChen)
names(result)<-result_names

#result_list<-list(ls(pattern='freqs*'))
#save what we have as Rdata
setwd("/Users/apple/Documents/R/Spr2017-proj4-team10/output")
save(result,file="spectralc_result.Rdata")
# save(freqs_AGupta, file = "AGupta.Rdata")
# save(freqs_AKumar, file = "AKumar.Rdata")
# save(freqs_CChen, file = "CChen.Rdata")
# save(freqs_DJohnson, file = "DJohnson.Rdata")
# save(freqs_JLee, file = "JLee.Rdata")
# save(freqs_JMartin, file = "JMartin.Rdata")
# save(freqs_JRobinson, file="JRobinson.Rdata")
# save(freqs_JSmith, file = "JSmith.Rdata")
# save(freqs_JTanaka, file = "JTanaka.Rdata")
# save(freqs_MBrown, file = "MBrown.Rdata")
# save(freqs_MJones, file = "MJones.Rdata")
# save(freqs_MMiller, file = "MMiller.Rdata")
# save(freqs_SLee, file = "SLee.Rdata")
# save(freqs_YChen, file = "YChen.Rdata")


```

```{r evaluation}
source('/Users/apple/Documents/R/Spr2017-proj4-team10/lib/evaluation_measures.R')
performance_sclust<-function(i){
  matching_matrix_ntf <- matching_matrix(Data[[i]]$AuthorID,result[[i]]$c_ntf)
  performance_ntf <- performance_statistics(matching_matrix_ntf)
  matching_matrix_tfidf <- matching_matrix(Data[[i]]$AuthorID,result[[i]]$c_tfidf)
  performance_tfidf <- performance_statistics(matching_matrix_tfidf)
  return(list(performance_tfidf,performance_ntf))
}

for(i in 1:length(file_names)){
  print(as.data.frame(performance_sclust(i)))
}

```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
